<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bảng Bình Chọn Online</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>

  <!-- Firebase compat SDKs (giữ nguyên API cũ) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  <style>
    /* Giữ nguyên toàn bộ CSS gốc của bạn ở đây */
  </style>
</head>
<body>
  <div class="container">
    <h1>BẢNG BÌNH CHỌN ONLINE</h1>
    <div class="instructions">
      <p><i class="fas fa-info-circle"></i><strong> Hướng dẫn:</strong> Nhấn vào các nút <i class="fas fa-plus"></i> và <i class="fas fa-minus"></i> để điều chỉnh số lượng. Kết quả sẽ được đồng bộ realtime qua Firebase.</p>
    </div>

    <table>
      <thead>
        <tr>
          <th>Gia đình</th>
          <th>Người lớn</th>
          <th>Trẻ em</th>
          <th>Tổng thành viên</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div class="summary">
      <h2><i class="fas fa-chart-pie"></i>TỔNG KẾT SỐ LƯỢNG THAM GIA</h2>
      <div class="summary-content">
        <div class="summary-item"><h3>Tổng số gia đình</h3><div class="summary-value" id="total-families">0</div></div>
        <div class="summary-item"><h3>Tổng số người lớn</h3><div class="summary-value" id="total-adults">0</div></div>
        <div class="summary-item"><h3>Tổng số trẻ em</h3><div class="summary-value" id="total-children">0</div></div>
        <div class="summary-item"><h3>Tổng số người tham gia</h3><div class="summary-value" id="total-participants">0</div></div>
      </div>
    </div>

    <div class="buttons">
      <button id="share-btn"><i class="fas fa-share-alt"></i> Chia sẻ</button>
    </div>

    <div class="share-section" id="share-section">
      <h2><i class="fas fa-share-alt"></i>Chia Sẻ Liên Kết</h2>
      <div class="share-options">
        <div class="share-option">
          <h3><i class="fas fa-link"></i> Liên kết chia sẻ</h3>
          <input type="text" id="share-link" readonly>
          <button class="copy-btn" id="copy-link-btn"><i class="fas fa-copy"></i> Sao chép liên kết</button>
        </div>
        <div class="share-option">
          <h3><i class="fas fa-qrcode"></i> Mã QR</h3>
          <div id="qrcode"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      // Danh sách gia đình
      const families = [
        "Gia đình ông Cửu","Gia đình ông Muôn","Gia đình ông Quảng","Gia đình cô Tứ","Gia đình cô Dẫn",
        "Gia đình cô Ngân","Gia đình cô Ngần","Gia đình cô Bé","Gia đình cô Bạn","Gia đình cô Chín"
      ];

      const tableBody = document.querySelector("tbody");
      const totalFamiliesElem = document.getElementById("total-families");
      const totalAdultsElem = document.getElementById("total-adults");
      const totalChildrenElem = document.getElementById("total-children");
      const totalParticipantsElem = document.getElementById("total-participants");
      const shareBtn = document.getElementById("share-btn");
      const shareSection = document.getElementById("share-section");
      const shareLink = document.getElementById("share-link");
      const copyLinkBtn = document.getElementById("copy-link-btn");
      const qrcodeDiv = document.getElementById("qrcode");

      // --- Firebase config (THAY BẰNG CỦA BẠN) ---
      const firebaseConfig = {
        apiKey: "YOUR_API_KEY",
        authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
        databaseURL: "https://YOUR_PROJECT_ID-default-rtdb.firebaseio.com",
        projectId: "YOUR_PROJECT_ID",
        storageBucket: "YOUR_PROJECT_ID.appspot.com",
        messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
        appId: "YOUR_APP_ID"
      };

      firebase.initializeApp(firebaseConfig);
      firebase.auth().signInAnonymously().catch(console.error);

      const db = firebase.database();
      const pollId = "poll-2-9-2025";  // tuỳ bạn đặt tên
      const votesRef = db.ref(`polls/${pollId}/votes`);

      let counters = [];

      // Render bảng
      function renderTable() {
        tableBody.innerHTML = "";
        families.forEach((family, index) => {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td class="family-name">${family}</td>
            <td>
              <div class="counter">
                <button class="counter-btn" data-family="${index}" data-type="adults" data-action="decrease">-</button>
                <span class="counter-value" id="adults-${index}">${counters[index].adults}</span>
                <button class="counter-btn" data-family="${index}" data-type="adults" data-action="increase">+</button>
              </div>
            </td>
            <td>
              <div class="counter">
                <button class="counter-btn" data-family="${index}" data-type="children" data-action="decrease">-</button>
                <span class="counter-value" id="children-${index}">${counters[index].children}</span>
                <button class="counter-btn" data-family="${index}" data-type="children" data-action="increase">+</button>
              </div>
            </td>
            <td id="total-${index}" style="font-weight:600">${counters[index].adults + counters[index].children}</td>
          `;
          tableBody.appendChild(row);
        });
      }

      // Update totals
      function updateTotals() {
        let totalAdults = 0, totalChildren = 0;
        counters.forEach((c) => {
          totalAdults += c.adults;
          totalChildren += c.children;
        });
        totalFamiliesElem.textContent = families.length;
        totalAdultsElem.textContent = totalAdults;
        totalChildrenElem.textContent = totalChildren;
        totalParticipantsElem.textContent = totalAdults + totalChildren;
      }

      // Lắng nghe thay đổi realtime
      votesRef.on("value", (snapshot) => {
        const data = snapshot.val();
        if (data) {
          counters = data;
          renderTable();
          updateTotals();
        }
      });

      // Xử lý click +/-
      document.addEventListener("click", (e) => {
        if (e.target.classList.contains("counter-btn")) {
          const idx = +e.target.dataset.family;
          const type = e.target.dataset.type;
          const action = e.target.dataset.action;
          votesRef.transaction((current) => {
            if (!current) return null;
            const next = [...current];
            if (!next[idx]) next[idx] = { adults: 0, children: 0 };
            next[idx][type] = Math.max(0, next[idx][type] + (action === "increase" ? 1 : -1));
            return next;
          });
        }
      });

      // Khởi tạo dữ liệu nếu chưa có
      votesRef.once("value").then((snap) => {
        if (!snap.exists()) {
          const initData = families.map(() => ({ adults: 0, children: 0 }));
          return votesRef.set(initData);
        }
      });

      // Nút chia sẻ
      shareBtn.addEventListener("click", () => {
        const currentUrl = window.location.href.split("?")[0];
        shareLink.value = currentUrl;
        qrcodeDiv.innerHTML = "";
        QRCode.toCanvas(currentUrl, { width: 200, height: 200 }, (err, canvas) => {
          if (!err) qrcodeDiv.appendChild(canvas);
        });
        shareSection.style.display = "block";
      });

      // Copy link
      copyLinkBtn.addEventListener("click", () => {
        shareLink.select();
        document.execCommand("copy");
        copyLinkBtn.innerHTML = "<i class='fas fa-check'></i> Đã sao chép!";
        setTimeout(() => (copyLinkBtn.innerHTML = "<i class='fas fa-copy'></i> Sao chép liên kết"), 2000);
      });
    });
  </script>
</body>
</html>
