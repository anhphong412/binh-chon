<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Bảng Bình Chọn Online</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
    <style>
        *{box-sizing:border-box;font-family:'Segoe UI',Arial,sans-serif}
        body{background:linear-gradient(135deg,#0068FF 0%,#6a11cb 100%);padding:20px;margin:0;color:#333;min-height:100vh}
        .container{width:95%;max-width:1200px;background:#fff;border-radius:15px;box-shadow:0 10px 30px rgba(0,0,0,.15);padding:30px;margin:20px auto}
        h1{text-align:center;color:#2c3e50;margin-bottom:25px;font-weight:700;border-bottom:2px solid #eee;padding-bottom:15px;font-size:28px}
        .instructions{background:#e8f4fc;padding:18px;border-radius:10px;margin-bottom:25px;border-left:5px solid #0068FF;font-size:16px;line-height:1.5}
        .instructions i{color:#0068FF;margin-right:10px}
        table{width:100%;border-collapse:collapse;margin:25px 0;box-shadow:0 3px 10px rgba(0,0,0,.08);font-size:16px}
        th,td{padding:16px;text-align:center;border:1px solid #e0e0e0}
        th{background:linear-gradient(to bottom,#0068FF,#0055D4);color:#fff;font-weight:600;position:sticky;top:0;font-size:17px}
        tr:nth-child(even){background:#f9f9f9}
        tr:hover{background:#f1f8ff;transition:.3s}
        .family-name{text-align:left;font-weight:600;color:#2c3e50;width:30%}
        .counter{display:flex;justify-content:center;align-items:center;gap:12px}
        .counter-btn{width:38px;height:38px;border:none;border-radius:50%;background:linear-gradient(to bottom,#0068FF,#0055D4);color:#fff;font-size:20px;cursor:pointer;transition:.2s;display:flex;align-items:center;justify-content:center;box-shadow:0 2px 5px rgba(0,0,0,.1)}
        .counter-btn:hover{background:linear-gradient(to bottom,#0055D4,#0047B5);transform:scale(1.1)}
        .counter-value{font-size:19px;font-weight:600;min-width:45px;text-align:center;padding:5px 10px;border-radius:20px;background:#f0f8ff;border:1px solid #d0e8ff}
        .summary{margin-top:35px;padding:25px;background:linear-gradient(to right,#f8f9fa,#e9ecef);border-radius:12px;border-left:5px solid #2ecc71}
        .summary h2{margin-top:0;color:#27ae60;font-weight:700;font-size:24px;display:flex;align-items:center}
        .summary h2 i{margin-right:12px}
        .summary-content{display:flex;justify-content:space-around;flex-wrap:wrap;gap:25px}
        .summary-item{text-align:center;padding:20px;background:#fff;border-radius:12px;box-shadow:0 3px 10px rgba(0,0,0,.08);min-width:200px;flex:1}
        .summary-item h3{margin:0;color:#7f8c8d;font-size:16px;font-weight:600}
        .summary-value{font-size:32px;font-weight:800;color:#0068FF;margin:15px 0;text-shadow:1px 1px 2px rgba(0,0,0,.1)}
        .buttons{display:flex;justify-content:center;gap:20px;margin-top:35px;flex-wrap:wrap}
        button{padding:15px 35px;border:none;border-radius:8px;font-size:18px;font-weight:600;cursor:pointer;transition:.3s;display:flex;align-items:center;justify-content:center}
        button i{margin-right:10px}
        #share-btn{background:linear-gradient(to right,#0068FF,#0055D4);color:#fff}
        #share-btn:hover{background:linear-gradient(to right,#0055D4,#0047B5);transform:translateY(-2px)}
        .save-confirmation{text-align:center;margin-top:20px;padding:15px;background:#d4edda;color:#155724;border-radius:8px;font-weight:600;display:none}
        .share-section{margin-top:30px;padding:25px;background:linear-gradient(to right,#f8f9fa,#e9ecef);border-radius:12px;border-left:5px solid #0068FF;display:none}
        .share-options{display:flex;flex-wrap:wrap;gap:20px;justify-content:space-around;margin-top:20px}
        .share-option{flex:1;min-width:300px;background:#fff;padding:20px;border-radius:10px;box-shadow:0 3px 10px rgba(0,0,0,.08)}
        #share-link{width:100%;padding:12px;border:1px solid #ddd;border-radius:6px;font-size:16px;margin-bottom:15px}
        .copy-btn{padding:10px 20px;background:linear-gradient(to right,#0068FF,#0055D4);color:#fff;border:none;border-radius:6px;cursor:pointer;font-weight:600}
    </style>
</head>
<body>
<div class="container">
    <h1>BẢNG BÌNH CHỌN ONLINE</h1>

    <div class="instructions">
        <p><i class="fas fa-info-circle"></i><strong> Hướng dẫn:</strong> Nhấn nút <i class="fas fa-plus"></i>/<i class="fas fa-minus"></i> để chỉnh số người lớn/trẻ em. Kết quả lưu tự động & đồng bộ realtime. Nhấn <strong>Chia sẻ</strong> để gửi link.</p>
    </div>

    <table>
        <thead>
            <tr>
                <th>Gia đình</th>
                <th>Người lớn</th>
                <th>Trẻ em</th>
                <th>Tổng thành viên</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <div class="summary">
        <h2><i class="fas fa-chart-pie"></i>TỔNG KẾT SỐ LƯỢNG THAM GIA</h2>
        <div class="summary-content">
            <div class="summary-item"><h3>Tổng số gia đình</h3><div class="summary-value" id="total-families">0</div></div>
            <div class="summary-item"><h3>Tổng số người lớn</h3><div class="summary-value" id="total-adults">0</div></div>
            <div class="summary-item"><h3>Tổng số trẻ em</h3><div class="summary-value" id="total-children">0</div></div>
            <div class="summary-item"><h3>Tổng số người tham gia</h3><div class="summary-value" id="total-participants">0</div></div>
        </div>
    </div>

    <div class="save-confirmation" id="save-confirmation">
        <i class="fas fa-check-circle"></i> Kết quả đã được lưu tự động!
    </div>

    <div class="buttons">
        <button id="share-btn"><i class="fas fa-share-alt"></i> Chia sẻ</button>
    </div>

    <div class="share-section" id="share-section">
        <h2><i class="fas fa-share-alt"></i>Chia Sẻ Liên Kết</h2>
        <p>Chia sẻ liên kết hoặc mã QR này để mọi người có thể tham gia bình chọn:</p>
        <div class="share-options">
            <div class="share-option">
                <h3><i class="fas fa-link"></i> Liên kết chia sẻ</h3>
                <input type="text" id="share-link" readonly>
                <button class="copy-btn" id="copy-link-btn"><i class="fas fa-copy"></i> Sao chép liên kết</button>
            </div>
            <div class="share-option">
                <h3><i class="fas fa-qrcode"></i> Mã QR</h3>
                <div id="qrcode"></div>
                <p style="text-align:center;margin-top:10px;font-size:14px;">Quét mã QR để tham gia bình chọn</p>
            </div>
        </div>
    </div>
</div>

<!-- Firebase + logic -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import { getAuth } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc, updateDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCHVmpS4V-bZ-6hKKvlnxHFudmXlTgh6s4",
  authDomain: "bang-binh-chon.firebaseapp.com",
  databaseURL: "https://bang-binh-chon-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "bang-binh-chon",
  storageBucket: "bang-binh-chon.firebasestorage.app",
  messagingSenderId: "1038624031736",
  appId: "1:1038624031736:web:c2e2e19907231cd8e58c0d"
};

// Init
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// ---------- DOM ----------
const families = [
  "Gia đình ông Cửu","Gia đình ông Muôn","Gia đình ông Quảng","Gia đình cô Tứ","Gia đình cô Dẫn",
  "Gia đình cô Ngần","Gia đình cô Ngân","Gia đình cô Bé","Gia đình cô Bạn","Gia đình cô Chín"
];
const tableBody = document.querySelector('tbody');
const totalFamiliesElem = document.getElementById('total-families');
const totalAdultsElem = document.getElementById('total-adults');
const totalChildrenElem = document.getElementById('total-children');
const totalParticipantsElem = document.getElementById('total-participants');
const saveConfirmation = document.getElementById('save-confirmation');
const shareBtn = document.getElementById('share-btn');
const shareSection = document.getElementById('share-section');
const shareLink = document.getElementById('share-link');
const copyLinkBtn = document.getElementById('copy-link-btn');
const qrcodeDiv = document.getElementById('qrcode');

// ---------- State & helpers ----------
let sessionId = new URLSearchParams(location.search).get('session') || localStorage.getItem('familySessionId');
if (!sessionId) {
  sessionId = 'family-' + Date.now() + '-' + Math.random().toString(36).slice(2, 11);
  localStorage.setItem('familySessionId', sessionId);
}
const sessionRef = doc(db, "sessions", sessionId);

const emptyCounters = () => families.map(() => ({ adults: 0, children: 0 }));

function normalizeCounters(counters) {
  const norm = emptyCounters();
  if (Array.isArray(counters)) {
    for (let i = 0; i < norm.length; i++) {
      const c = counters[i] || {};
      norm[i] = {
        adults: Number.isFinite(+c.adults) ? +c.adults : 0,
        children: Number.isFinite(+c.children) ? +c.children : 0
      };
    }
  }
  return norm;
}

function renderTableOnce() {
  // build rows once
  const counters = emptyCounters();
  tableBody.innerHTML = '';
  families.forEach((family, i) => {
    const row = document.createElement('tr');
    row.innerHTML = `
      <td class="family-name">${family}</td>
      <td>
        <div class="counter">
          <button class="counter-btn" data-family="${i}" data-type="adults" data-action="decrease">-</button>
          <span class="counter-value" id="adults-${i}">${counters[i].adults}</span>
          <button class="counter-btn" data-family="${i}" data-type="adults" data-action="increase">+</button>
        </div>
      </td>
      <td>
        <div class="counter">
          <button class="counter-btn" data-family="${i}" data-type="children" data-action="decrease">-</button>
          <span class="counter-value" id="children-${i}">${counters[i].children}</span>
          <button class="counter-btn" data-family="${i}" data-type="children" data-action="increase">+</button>
        </div>
      </td>
      <td id="total-${i}" style="font-weight:600">${counters[i].adults + counters[i].children}</td>
    `;
    tableBody.appendChild(row);
  });
  // show totals base
  updateTotals(counters);
}

function updateTotals(counters) {
  let a = 0, c = 0;
  counters.forEach((x, i) => {
    a += x.adults; c += x.children;
    const ad = document.getElementById(`adults-${i}`);
    const ch = document.getElementById(`children-${i}`);
    const tt = document.getElementById(`total-${i}`);
    if (ad) ad.textContent = x.adults;
    if (ch) ch.textContent = x.children;
    if (tt) tt.textContent = x.adults + x.children;
  });
  totalFamiliesElem.textContent = families.length;
  totalAdultsElem.textContent = a;
  totalChildrenElem.textContent = c;
  totalParticipantsElem.textContent = a + c;

  saveConfirmation.style.display = 'block';
  setTimeout(()=> saveConfirmation.style.display = 'none', 1500);
}

// ---------- Initial render (always show full table) ----------
renderTableOnce();

// ---------- Ensure session doc exists & subscribe ----------
(async () => {
  try {
    const snap = await getDoc(sessionRef);
    if (!snap.exists()) {
      await setDoc(sessionRef, { families, counters: emptyCounters() });
    } else {
      // Nếu counters cũ dài/thiếu → normalize và cập nhật
      const fixed = normalizeCounters(snap.data().counters);
      if (JSON.stringify(fixed) !== JSON.stringify(snap.data().counters)) {
        await updateDoc(sessionRef, { counters: fixed });
      }
    }
  } catch (err) {
    console.error('Firestore init error:', err);
  }

  // Lắng nghe realtime và chỉ cập nhật số liệu
  onSnapshot(sessionRef, (docSnap) => {
    if (!docSnap.exists()) return;
    const data = docSnap.data();
    const counters = normalizeCounters(data.counters);
    updateTotals(counters);
  }, (err) => {
    console.error('Snapshot error:', err);
  });
})();

// ---------- Click handlers (+/-) ----------
document.addEventListener('click', async (e) => {
  if (!e.target.classList.contains('counter-btn')) return;
  const idx = parseInt(e.target.dataset.family);
  const type = e.target.dataset.type;   // 'adults' | 'children'
  const act  = e.target.dataset.action; // 'increase' | 'decrease'

  try {
    const s = await getDoc(sessionRef);
    if (!s.exists()) return;
    const counters = normalizeCounters(s.data().counters);
    if (act === 'increase') counters[idx][type] += 1;
    if (act === 'decrease' && counters[idx][type] > 0) counters[idx][type] -= 1;
    await updateDoc(sessionRef, { counters });
  } catch (err) {
    console.error('Update error:', err);
  }
});

// ---------- Share ----------
shareBtn.addEventListener('click', () => {
  const url = location.href.split('?')[0] + `?session=${sessionId}`;
  shareLink.value = url;
  qrcodeDiv.innerHTML = '';
  QRCode.toCanvas(url, { width: 200, height: 200 }, (err, canvas) => {
    if (!err) qrcodeDiv.appendChild(canvas);
  });
  shareSection.style.display = 'block';
});

copyLinkBtn.addEventListener('click', async () => {
  const url = shareLink.value;
  try {
    if (navigator.clipboard?.writeText) {
      await navigator.clipboard.writeText(url);
    } else {
      shareLink.select(); document.execCommand('copy');
    }
    copyLinkBtn.innerHTML = '<i class="fas fa-check"></i> Đã sao chép!';
    setTimeout(()=> copyLinkBtn.innerHTML = '<i class="fas fa-copy"></i> Sao chép liên kết', 1500);
  } catch {
    alert('Không sao chép được, hãy copy thủ công.');
  }
});
</script>
</body>
</html>
