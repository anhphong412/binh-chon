<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bảng Bình Chọn Online</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            font-family: 'Segoe UI', Arial, sans-serif;
        }
        body {
            background: linear-gradient(135deg, #0068FF 0%, #6a11cb 100%);
            padding: 20px;
            margin: 0;
            color: #333;
            min-height: 100vh;
        }
        .container {
            width: 95%;
            max-width: 1200px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            padding: 30px;
            margin: 20px auto;
        }
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 25px;
            font-weight: 700;
            border-bottom: 2px solid #eee;
            padding-bottom: 15px;
            font-size: 28px;
        }
        .instructions {
            background-color: #e8f4fc;
            padding: 18px;
            border-radius: 10px;
            margin-bottom: 25px;
            border-left: 5px solid #0068FF;
            font-size: 16px;
            line-height: 1.5;
        }
        .instructions i {
            color: #0068FF;
            margin-right: 10px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 25px 0;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
            font-size: 16px;
        }
        th, td {
            padding: 16px;
            text-align: center;
            border: 1px solid #e0e0e0;
        }
        th {
            background: linear-gradient(to bottom, #0068FF, #0055D4);
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
            font-size: 17px;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        tr:hover {
            background-color: #f1f8ff;
            transition: background-color 0.3s;
        }
        .family-name {
            text-align: left;
            font-weight: 600;
            color: #2c3e50;
            width: 30%;
        }
        .counter {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 12px;
        }
        .counter-btn {
            width: 38px;
            height: 38px;
            border: none;
            border-radius: 50%;
            background: linear-gradient(to bottom, #0068FF, #0055D4);
            color: white;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        .counter-btn:hover {
            background: linear-gradient(to bottom, #0055D4, #0047B5);
            transform: scale(1.1);
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.15);
        }
        .counter-value {
            font-size: 19px;
            font-weight: 600;
            min-width: 45px;
            text-align: center;
            padding: 5px 10px;
            border-radius: 20px;
            background-color: #f0f8ff;
            border: 1px solid #d0e8ff;
        }
        .summary {
            margin-top: 35px;
            padding: 25px;
            background: linear-gradient(to right, #f8f9fa, #e9ecef);
            border-radius: 12px;
            border-left: 5px solid #2ecc71;
        }
        .summary h2 {
            margin-top: 0;
            color: #27ae60;
            font-weight: 700;
            font-size: 24px;
            display: flex;
            align-items: center;
        }
        .summary h2 i {
            margin-right: 12px;
        }
        .summary-content {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 25px;
        }
        .summary-item {
            text-align: center;
            padding: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
            min-width: 200px;
            flex: 1;
        }
        .summary-item h3 {
            margin: 0;
            color: #7f8c8d;
            font-size: 16px;
            font-weight: 600;
        }
        .summary-value {
            font-size: 32px;
            font-weight: 800;
            color: #0068FF;
            margin: 15px 0;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }
        .buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 35px;
            flex-wrap: wrap;
        }
        button {
            padding: 15px 35px;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        button i {
            margin-right: 10px;
        }
        #save-btn {
            background: linear-gradient(to right, #2ecc71, #27ae60);
            color: white;
        }
        #save-btn:hover {
            background: linear-gradient(to right, #27ae60, #219653);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }
        #share-btn {
            background: linear-gradient(to right, #0068FF, #0055D4);
            color: white;
        }
        #share-btn:hover {
            background: linear-gradient(to right, #0055D4, #0047B5);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }
        .save-confirmation {
            text-align: center;
            margin-top: 20px;
            padding: 15px;
            background-color: #d4edda;
            color: #155724;
            border-radius: 8px;
            font-weight: 600;
            display: none;
            animation: fadeIn 0.5s;
        }
        .share-section {
            margin-top: 30px;
            padding: 25px;
            background: linear-gradient(to right, #f8f9fa, #e9ecef);
            border-radius: 12px;
            border-left: 5px solid #0068FF;
            display: none;
        }
        .share-section h2 {
            margin-top: 0;
            color: #0068FF;
            font-weight: 700;
            font-size: 24px;
            display: flex;
            align-items: center;
        }
        .share-section h2 i {
            margin-right: 12px;
        }
        .share-options {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: space-around;
            margin-top: 20px;
        }
        .share-option {
            flex: 1;
            min-width: 300px;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
        }
        .share-option h3 {
            margin-top: 0;
            color: #7f8c8d;
            display: flex;
            align-items: center;
        }
        .share-option h3 i {
            margin-right: 10px;
            color: #0068FF;
        }
        #share-link {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            margin-bottom: 15px;
        }
        .copy-btn {
            padding: 10px 20px;
            background: linear-gradient(to right, #0068FF, #0055D4);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }
        .copy-btn:hover {
            background: linear-gradient(to right, #0055D4, #0047B5);
        }
        #qrcode {
            display: flex;
            justify-content: center;
            margin-top: 15px;
        }
        .zalo-share {
            display: flex;
            justify-content: center;
            margin-top: 20px;
        }
        .zalo-share-button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background-color: #0068FF;
            color: white;
            padding: 12px 20px;
            border-radius: 6px;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.2s;
        }
        .zalo-share-button:hover {
            background-color: #0055D4;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }
        .zalo-share-button i {
            margin-right: 10px;
            font-size: 20px;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @media (max-width: 992px) {
            .container {
                padding: 20px;
            }
            th, td {
                padding: 12px;
            }
            .summary-content {
                gap: 15px;
            }
            .summary-item {
                min-width: 160px;
                padding: 15px;
            }
            .summary-value {
                font-size: 28px;
            }
        }
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            .container {
                padding: 15px;
                border-radius: 12px;
            }
            th, td {
                padding: 10px;
                font-size: 14px;
            }
            .counter-btn {
                width: 32px;
                height: 32px;
                font-size: 16px;
            }
            .counter-value {
                font-size: 16px;
                min-width: 35px;
            }
            .summary-item {
                min-width: 120px;
                padding: 12px;
            }
            .summary-value {
                font-size: 24px;
            }
            button {
                padding: 12px 25px;
                font-size: 16px;
            }
        }
        @media (max-width: 576px) {
            .counter {
                flex-direction: column;
                gap: 8px;
            }
            .summary-content {
                flex-direction: column;
            }
            .share-options {
                flex-direction: column;
            }
        }
        .firebase-status {
            text-align: center;
            padding: 10px;
            margin: 10px 0;
            border-radius: 8px;
            font-weight: 600;
        }
        .status-connected {
            background-color: #d4edda;
            color: #155724;
        }
        .status-disconnected {
            background-color: #f8d7da;
            color: #721c24;
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>BẢNG BÌNH CHỌN ONLINE</h1>
        
        <div id="firebase-status" class="firebase-status status-disconnected">
            <span id="status-text">Đang kết nối đến Firebase... <span class="loading"></span></span>
        </div>
        
        <div class="instructions">
            <p><i class="fas fa-info-circle"></i><strong> Hướng dẫn:</strong> Nhấn vào các nút <i class="fas fa-plus"></i> và <i class="fas fa-minus"></i> để điều chỉnh số lượng người lớn và trẻ em tham gia từ mỗi gia đình. Kết quả sẽ được lưu tự động vào Firebase. Sử dụng nút <strong>Chia sẻ</strong> để chia sẻ liên kết cho mọi người cùng tham gia bình chọn.</p>
        </div>
        
        <table>
            <thead>
                <tr>
                    <th>Gia đình</th>
                    <th>Người lớn</th>
                    <th>Trẻ em</th>
                    <th>Tổng thành viên</th>
                </tr>
            </thead>
            <tbody>
                <!-- Các hàng dữ liệu sẽ được thêm bằng JavaScript -->
            </tbody>
        </table>
        
        <div class="summary">
            <h2><i class="fas fa-chart-pie"></i>TỔNG KẾT SỐ LƯỢNG THAM GIA</h2>
            <div class="summary-content">
                <div class="summary-item">
                    <h3>Tổng số gia đình</h3>
                    <div class="summary-value" id="total-families">0</div>
                </div>
                <div class="summary-item">
                    <h3>Tổng số người lớn</h3>
                    <div class="summary-value" id="total-adults">0</div>
                </div>
                <div class="summary-item">
                    <h3>Tổng số trẻ em</h3>
                    <div class="summary-value" id="total-children">0</div>
                </div>
                <div class="summary-item">
                    <h3>Tổng số người tham gia</h3>
                    <div class="summary-value" id="total-participants">0</div>
                </div>
            </div>
        </div>
        
        <div class="save-confirmation" id="save-confirmation">
            <i class="fas fa-check-circle"></i> Kết quả đã được lưu vào Firebase!
        </div>
        
        <div class="buttons">
            <button id="reset-btn">
                <i class="fas fa-redo"></i> Đặt lại
            </button>
            <button id="share-btn">
                <i class="fas fa-share-alt"></i> Chia sẻ
            </button>
        </div>
        
        <div class="share-section" id="share-section">
            <h2><i class="fas fa-share-alt"></i>Chia Sẻ Liên Kết</h2>
            <p>Chia sẻ liên kết hoặc mã QR này để mọi người có thể tham gia bình chọn:</p>
            
            <div class="share-options">
                <div class="share-option">
                    <h3><i class="fas fa-link"></i> Liên kết chia sẻ</h3>
                    <input type="text" id="share-link" readonly>
                    <button class="copy-btn" id="copy-link-btn">
                        <i class="fas fa-copy"></i> Sao chép liên kết
                    </button>
                </div>
                
                <div class="share-option">
                    <h3><i class="fas fa-qrcode"></i> Mã QR</h3>
                    <div id="qrcode"></div>
                    <p style="text-align: center; margin-top: 10px; font-size: 14px;">Quét mã QR để tham gia bình chọn</p>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // Import Firebase SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
        import { getDatabase, ref, set, onValue, get } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCHVmpS4V-bZ-6hKkvlnxHFudmXlTgh6s4",
            authDomain: "bang-binh-chon.firebaseapp.com",
            databaseURL: "https://bang-binh-chon-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "bang-binh-chon",
            storageBucket: "bang-binh-chon.firebasestorage.app",
            messagingSenderId: "1038624031736",
            appId: "1:1038624031736:web:c2e2e19907231cd8e58c0d"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        document.addEventListener('DOMContentLoaded', function() {
            // Dữ liệu các gia đình
            const families = [
                "Gia đình ông Cửu",
                "Gia đình ông Muôn",
                "Gia đình ông Quảng",
                "Gia đình cô Tứ",
                "Gia đình cô Dẫn",
                "Gia đình cô Ngần",
                "Gia đình cô Ngân",
                "Gia đình cô Bé",
                "Gia đình cô Bạn",
                "Gia đình cô Chín"
            ];
            
            const tableBody = document.querySelector('tbody');
            const totalFamiliesElem = document.getElementById('total-families');
            const totalAdultsElem = document.getElementById('total-adults');
            const totalChildrenElem = document.getElementById('total-children');
            const totalParticipantsElem = document.getElementById('total-participants');
            const saveConfirmation = document.getElementById('save-confirmation');
            const shareSection = document.getElementById('share-section');
            const shareLink = document.getElementById('share-link');
            const copyLinkBtn = document.getElementById('copy-link-btn');
            const shareBtn = document.getElementById('share-btn');
            const resetBtn = document.getElementById('reset-btn');
            const qrcodeDiv = document.getElementById('qrcode');
            const firebaseStatus = document.getElementById('firebase-status');
            const statusText = document.getElementById('status-text');

            // Generate unique session ID
            let sessionId = localStorage.getItem('familySessionId');
            if (!sessionId) {
                sessionId = 'family-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('familySessionId', sessionId);
            }

            let counters = families.map(() => ({ adults: 0, children: 0 }));

            // Update Firebase status
            function updateFirebaseStatus(connected) {
                firebaseStatus.className = `firebase-status ${connected ? 'status-connected' : 'status-disconnected'}`;
                statusText.innerHTML = connected ? 
                    '<i class="fas fa-check-circle"></i> Đã kết nối với Firebase' : 
                    'Không thể kết nối với Firebase <span class="loading"></span>';
            }

            // Save data to Firebase
            async function saveToFirebase() {
                try {
                    await set(ref(db, 'sessions/' + sessionId), counters);
                    saveConfirmation.style.display = 'block';
                    setTimeout(() => {
                        saveConfirmation.style.display = 'none';
                    }, 3000);
                } catch (error) {
                    console.error('Error saving to Firebase:', error);
                    updateFirebaseStatus(false);
                }
            }

            // Load data from Firebase
            async function loadFromFirebase(sessionIdToLoad) {
                try {
                    const snapshot = await get(ref(db, 'sessions/' + sessionIdToLoad));
                    if (snapshot.exists()) {
                        counters = snapshot.val();
                        createTableRows();
                        updateTotals();
                        updateFirebaseStatus(true);
                    } else {
                        // Initialize new session data
                        counters = families.map(() => ({ adults: 0, children: 0 }));
                        await saveToFirebase();
                    }
                } catch (error) {
                    console.error('Error loading from Firebase:', error);
                    updateFirebaseStatus(false);
                }
            }

            // Create table rows
            function createTableRows() {
                tableBody.innerHTML = '';
                families.forEach((family, index) => {
                    const row = document.createElement('tr');
                    
                    const nameCell = document.createElement('td');
                    nameCell.textContent = family;
                    nameCell.className = 'family-name';
                    row.appendChild(nameCell);
                    
                    const adultsCell = document.createElement('td');
                    adultsCell.innerHTML = `
                        <div class="counter">
                            <button class="counter-btn" data-family="${index}" data-type="adults" data-action="decrease">-</button>
                            <span class="counter-value" id="adults-${index}">${counters[index].adults}</span>
                            <button class="counter-btn" data-family="${index}" data-type="adults" data-action="increase">+</button>
                        </div>
                    `;
                    row.appendChild(adultsCell);
                    
                    const childrenCell = document.createElement('td');
                    childrenCell.innerHTML = `
                        <div class="counter">
                            <button class="counter-btn" data-family="${index}" data-type="children" data-action="decrease">-</button>
                            <span class="counter-value" id="children-${index}">${counters[index].children}</span>
                            <button class="counter-btn" data-family="${index}" data-type="children" data-action="increase">+</button>
                        </div>
                    `;
                    row.appendChild(childrenCell);
                    
                    const totalCell = document.createElement('td');
                    totalCell.id = `total-${index}`;
                    totalCell.textContent = counters[index].adults + counters[index].children;
                    totalCell.style.fontWeight = '600';
                    row.appendChild(totalCell);
                    
                    tableBody.appendChild(row);
                });
            }

            // Update totals display
            function updateTotals() {
                let totalAdults = 0;
                let totalChildren = 0;
                
                counters.forEach((counter, index) => {
                    totalAdults += counter.adults;
                    totalChildren += counter.children;
                    
                    document.getElementById(`adults-${index}`).textContent = counter.adults;
                    document.getElementById(`children-${index}`).textContent = counter.children;
                    document.getElementById(`total-${index}`).textContent = counter.adults + counter.children;
                });
                
                totalFamiliesElem.textContent = families.length;
                totalAdultsElem.textContent = totalAdults;
                totalChildrenElem.textContent = totalChildren;
                totalParticipantsElem.textContent = totalAdults + totalChildren;
                
                saveToFirebase();
            }

            // Real-time listener for Firebase data
            const sessionRef = ref(db, 'sessions/' + sessionId);
            onValue(sessionRef, (snapshot) => {
                if (snapshot.exists()) {
                    counters = snapshot.val();
                    createTableRows();
                    updateTotals();
                    updateFirebaseStatus(true);
                }
            }, (error) => {
                console.error('Error listening to Firebase:', error);
                updateFirebaseStatus(false);
            });

            // Handle counter button clicks
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('counter-btn')) {
                    const familyIndex = parseInt(e.target.dataset.family);
                    const type = e.target.dataset.type;
                    const action = e.target.dataset.action;
                    
                    if (action === 'increase') {
                        counters[familyIndex][type]++;
                    } else if (action === 'decrease' && counters[familyIndex][type] > 0) {
                        counters[familyIndex][type]--;
                    }
                    
                    updateTotals();
                }
            });

            // Reset button handler
            resetBtn.addEventListener('click', async function() {
                if (confirm('Bạn có chắc chắn muốn đặt lại tất cả số liệu về 0?')) {
                    counters = families.map(() => ({ adults: 0, children: 0 }));
                    await saveToFirebase();
                    updateTotals();
                    alert('Đã đặt lại tất cả số liệu về 0');
                }
            });

            // Share button handler
            shareBtn.addEventListener('click', function() {
                const currentUrl = window.location.href.split('?')[0];
                const shareUrl = `${currentUrl}?session=${sessionId}`;
                shareLink.value = shareUrl;
                
                qrcodeDiv.innerHTML = '';
                QRCode.toCanvas(shareUrl, { width: 200, height: 200 }, function(err, canvas) {
                    if (err) console.error(err);
                    qrcodeDiv.appendChild(canvas);
                });
                
                shareSection.style.display = 'block';
            });

            // Copy link button handler
            copyLinkBtn.addEventListener('click', function() {
                shareLink.select();
                document.execCommand('copy');
                
                const originalText = copyLinkBtn.innerHTML;
                copyLinkBtn.innerHTML = '<i class="fas fa-check"></i> Đã sao chép!';
                setTimeout(() => {
                    copyLinkBtn.innerHTML = originalText;
                }, 2000);
            });

            // Handle shared session from URL
            const urlParams = new URLSearchParams(window.location.search);
            const sharedSessionId = urlParams.get('session');
            
            if (sharedSessionId && sharedSessionId !== sessionId) {
                if (confirm('Bạn muốn tải dữ liệu từ liên kết được chia sẻ không?')) {
                    sessionId = sharedSessionId;
                    localStorage.setItem('familySessionId', sessionId);
                    loadFromFirebase(sessionId);
                }
            } else {
                loadFromFirebase(sessionId);
            }
        });
    </script>
</body>
</html>
